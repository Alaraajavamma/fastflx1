#!/bin/bash

# ==============================================================================
#
#   Andromeda listener
#
#   - This version unconditionally attempts to create the mount points
#     every time it is executed, regardless of the container's status.
#   - Mounts are intended to be permanent until reboot or manual unmount.
#
# ==============================================================================


# --- Main Configuration ---
# The base directory on the host where mount points will be created.
SHARED_DIR="$HOME/Shared"
# Use 'sudo' directly. Requires a passwordless sudoers rule to be configured.
SUDO_CMD="sudo"


# ==============================================================================
# ==                               FUNCTION                                   ==
# ==============================================================================

# ---
# Function to set up the main, full directory bind mounts.
# ---
setup_main_mounts() {
    echo "[$(date)] [SETUP] Starting unconditional mount process..."

    local HOST_TARGET_DIR="$SHARED_DIR/Linux"
    local ANDROID_TARGET_DIR="$SHARED_DIR/Android"

    echo "[$(date)] [MKDIR] Ensuring target directory exists: $HOST_TARGET_DIR"
    mkdir -p "$HOST_TARGET_DIR"
    echo "[$(date)] [MKDIR] Ensuring target directory exists: $ANDROID_TARGET_DIR"
    mkdir -p "$ANDROID_TARGET_DIR"

    # --- Mount full host home directory ---
    echo "[$(date)] [MOUNT] Binding full host home to $HOST_TARGET_DIR"
    $SUDO_CMD mount --bind "$HOME" "$HOST_TARGET_DIR"

    # --- Find and mount full Android data directory ---
    local ANDROMEDA_PATH="$HOME/.local/share/andromeda/data/media/0"
    local WAYDROID_PATH="$HOME/.local/share/waydroid/data/media/0"
    local ANDROID_SOURCE_PATH=""

    if $SUDO_CMD test -d "$ANDROMEDA_PATH"; then
        ANDROID_SOURCE_PATH="$ANDROMEDA_PATH"
    elif $SUDO_CMD test -d "$WAYDROID_PATH"; then
        ANDROID_SOURCE_PATH="$WAYDROID_PATH"
    else
        echo "[$(date)] [ERROR] Could not find Android data directory. Aborting mount."
        return 1
    fi
    
    echo "[$(date)] [INFO] Found Android data at: $ANDROID_SOURCE_PATH"
    
    echo "[$(date)] [SETPERMS] Applying recursive permissions to $ANDROID_SOURCE_PATH..."
    $SUDO_CMD setfacl -R -m u:"$USER":rwx "$ANDROID_SOURCE_PATH"
    
    echo "[$(date)] [MOUNT] Binding full Android data to $ANDROID_TARGET_DIR"
    $SUDO_CMD mount --bind "$ANDROID_SOURCE_PATH" "$ANDROID_TARGET_DIR"
    
    echo "[$(date)] [SETUP] Full directory mount process finished."
}


# ==============================================================================
# ==                            MAIN EXECUTION                                ==
# ==============================================================================

echo "[$(date)] [INIT] Starting Andromeda Listener (Unconditional Mount Mode)..."

# Directly call the mount function without any checks.
setup_main_mounts

echo "[$(date)] [DONE] Script execution finished."