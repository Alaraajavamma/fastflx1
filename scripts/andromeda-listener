#!/bin/bash

# ==============================================================================
#
#   Andromeda Manager - v14.1 (Andromeda-Only Selective Mount)
#
#   - This script uses 'bindfs' to create two-way mounts with exclusions.
#   - It is designed to work ONLY with the Andromeda data path.
#   - It should be run once per session (e.g., on system boot).
#
#   ** DEPENDENCY: This script requires 'bindfs' to be installed. **
#
# ==============================================================================

# --- Main Configuration ---
SUDO_CMD="sudo"

echo "[$(date)] [INIT] Starting Andromeda Manager (bindfs Selective Mount Mode)..."

# --- Step 0: Verify 'bindfs' dependency ---
if ! command -v bindfs &> /dev/null; then
    echo "[$(date)] [ERROR] 'bindfs' is not installed. Please install it to continue."
    echo "[$(date)] [ERROR] On Debian/Ubuntu: sudo apt install bindfs"
    exit 1
fi
echo "[$(date)] [INFO] 'bindfs' dependency confirmed."

# --- Step 1: Define and verify the Andromeda data path ---
ANDROID_DATA_PATH="$HOME/.local/share/andromeda/data/media/0"

if ! $SUDO_CMD test -d "$ANDROID_DATA_PATH"; then
    echo "[$(date)] [ERROR] The Andromeda data directory does not exist at: $ANDROID_DATA_PATH"
    echo "[$(date)] [ERROR] Please ensure Andromeda is installed and has run once. Aborting."
    exit 1
fi
echo "[$(date)] [INFO] Using Andromeda data path: $ANDROID_DATA_PATH"


# --- Step 2: Mount Android Data -> ~/Shared-Andromeda (with exclusions) ---
HOST_TARGET_DIR="$HOME/Shared-Andromeda"

echo "[$(date)] [SETUP] Preparing mount point: $HOST_TARGET_DIR"
mkdir -p "$HOST_TARGET_DIR"

echo "[$(date)] [MOUNT] Mounting Android data to host..."
$SUDO_CMD bindfs \
    --hide-from-glob='Host' \
    --hide-from-glob='Shared-Linux' \
    --hide-from-glob='.*' \
    -o "force-user=$USER,force-group=$(id -g -n),nonempty" \
    "$ANDROID_DATA_PATH" "$HOST_TARGET_DIR"

echo "[$(date)] [INFO] Successfully mounted '$ANDROID_DATA_PATH' to '$HOST_TARGET_DIR'"


# --- Step 3: Mount Home -> Android Data/Shared-Linux (with exclusions) ---
ANDROID_TARGET_DIR="$ANDROID_DATA_PATH/Shared-Linux"

echo "[$(date)] [SETUP] Preparing mount point: $ANDROID_TARGET_DIR"
# The target directory must be created with sudo as its parent is root-owned
$SUDO_CMD mkdir -p "$ANDROID_TARGET_DIR"
$SUDO_CMD chown "$USER:$(id -g -n)" "$ANDROID_TARGET_DIR"

echo "[$(date)] [MOUNT] Mounting host home to Android data..."
$SUDO_CMD bindfs \
    --hide-from-glob='Android' \
    --hide-from-glob='Shared-Andromeda' \
    --hide-from-glob='.*' \
    -o "force-user=$USER,force-group=$(id -g -n),nonempty" \
    "$HOME" "$ANDROID_TARGET_DIR"

echo "[$(date)] [INFO] Successfully mounted '$HOME' to '$ANDROID_TARGET_DIR'"


echo "[$(date)] [DONE] All selective mount operations are complete."