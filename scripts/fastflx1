#!/bin/bash

# --- Configuration ---
# Main script that manages mounting and the permission guard
ANDROMEDA_SCRIPT_PATH="/usr/bin/andromeda-shared-folders"
# The new helper script that will be created for autostart
HELPER_SCRIPT_PATH="/usr/bin/andromeda-autostart-helper"
# The user's local autostart file
AUTOSTART_FILE="${HOME}/.config/autostart/andromeda-shared-folders.desktop"
# The sudoers file for passwordless unmounting/stopping
SUDOERS_FILE="/etc/sudoers.d/99-andromeda-folders-permissions"

# --- Helper Functions ---

# This function kills wofi if the user enters the overview/activities mode.
wofi_kill() {
    # Run in the background so the main script can continue
    dbus-monitor "interface='org.freedesktop.DBus.Properties',member='PropertiesChanged',path='/org/gnome/Shell'" | \
    while read -r line; do
        # Check if the OverviewActive property has changed to true
        if echo "$line" | grep -q "string \"OverviewActive\""; then
            read -r next_line
            if echo "$next_line" | grep -q "boolean true"; then
                if pgrep -x wofi > /dev/null; then
                    pkill -x wofi
                fi
                # Exit the monitor loop once wofi is killed
                break
            fi
        fi
    done &
}

# This function handles the entire process of enabling the shared folders.
enable_sharing() {
    # This multi-line command will be executed in a new terminal window.
    local term_command
    term_command=$(cat <<EOF
        # This script runs inside the new terminal. Exit immediately if a command fails.
        set -e

        echo "--- ENABLING ANDROMEDA SHARED FOLDERS ---"
        sleep 1

        echo "[STEP 1/4] Mounting shared folders (requires password)..."
        # We explicitly pass TARGET_USER so the script knows who to run for.
        sudo env TARGET_USER=\${USER} ${ANDROMEDA_SCRIPT_PATH} mount
        sleep 1

        echo "[STEP 2/4] Creating autostart helper script..."
        # Heredoc ('EOF') to prevent variable expansion inside the helper script content.
        # This helper script contains the robust logic for waiting on system services.
        sudo tee "${HELPER_SCRIPT_PATH}" > /dev/null <<'HELPER_EOF'
#!/bin/bash

# This script waits for the keyring and graphical shell to be ready, then starts the permission guard.
# It logs its output to the system journal for easy debugging.
# Use 'journalctl -f -t andromeda-helper' to view logs.
exec > >(systemd-cat -t andromeda-helper) 2>&1

echo "Andromeda autostart helper started."

# 1. Wait for the Freedesktop secrets service (GNOME Keyring) to be available on D-Bus.
# This is more robust than just trying to call it in a loop.
echo "Waiting for keyring service (org.freedesktop.secrets)..."
if ! gdbus wait --session --timeout 60 --activate-name-owner org.freedesktop.secrets; then
    echo "ERROR: Timed out waiting for the keyring service. Aborting."
    exit 1
fi
echo "Keyring service is available."

# 2. Now that the service is running, wait for the 'login' collection to be unlocked.
echo "Waiting for keyring to be unlocked..."
while gdbus call --session --dest org.freedesktop.secrets --object-path /org/freedesktop/secrets/collection/login --method org.freedesktop.DBus.Properties.Get org.freedesktop.Secret.Collection 'Locked' | grep -q "true"; do
    sleep 1
done
echo "Keyring is unlocked."

# 3. Wait for the GNOME Shell to be ready.
# This ensures the graphical Polkit agent is running before we call pkexec.
echo "Waiting for GNOME Shell to be ready..."
if ! gdbus wait --session --timeout 60 --activate-name-owner org.gnome.Shell; then
    echo "WARNING: Timed out waiting for GNOME Shell. pkexec might not show a graphical prompt."
fi
echo "GNOME Shell is ready."

# 4. All checks passed. Start the permission guard via pkexec.
echo "Starting permission guard..."
pkexec ${ANDROMEDA_SCRIPT_PATH} start-permission-guard
echo "Helper script finished."
sleep 2

HELPER_EOF
        sudo chmod +x "${HELPER_SCRIPT_PATH}"
        sleep 1

        echo "[STEP 3/4] Creating autostart .desktop entry..."
        # The Exec line is now clean, just calling our new helper script.
        DESKTOP_FILE_CONTENT="[Desktop Entry]\nVersion=1.0\nName=Andromeda-Shared-Folders\nComment=Starts the service to sync permissions for shared folders\nExec=${HELPER_SCRIPT_PATH}\nIcon=folder-remote\nTerminal=false\nType=Application"
        
        mkdir -p "$(dirname "${AUTOSTART_FILE}")"
        echo -e "\${DESKTOP_FILE_CONTENT}" > '${AUTOSTART_FILE}'
        sleep 1
        
        echo "[STEP 4/4] Finalizing setup..."
        echo "---"
        echo "Setup complete! Shared folders are active and will start automatically on login."
        notify-send "Andromeda Shared Folders Enabled" --icon="folder-remote"
        
        # Prompt for reboot
        read -p "A reboot is recommended to finalize the setup. Type 'Yes' to reboot now: " reboot_choice
        
        # Check if the user wants to reboot, ignoring case
        if [[ "\${reboot_choice^^}" == "YES" ]]; then
            echo "Rebooting now..."
            sudo reboot
        else
            echo "Reboot cancelled. Please reboot manually later."
            read -p "Press <Enter> to close this window."
        fi
EOF
)
    # Launch the terminal and execute the command block.
    kgx -- bash -c "$term_command"
}

# This function handles the entire process of disabling the shared folders.
disable_sharing() {
    local term_command
    term_command=$(cat <<EOF
        set -e
        echo "--- DISABLING ANDROMEDA SHARED FOLDERS ---"
        sleep 1
        
        echo "[STEP 1/5] Stopping the permission guard service (requires password)..."
        sudo env TARGET_USER=\${USER} ${ANDROMEDA_SCRIPT_PATH} stop-permission-guard
        sleep 1

        echo "[STEP 2/5] Unmounting all shared folders..."
        sudo env TARGET_USER=\${USER} ${ANDROMEDA_SCRIPT_PATH} unmount
        sleep 1

        echo "[STEP 3/5] Removing autostart .desktop entry..."
        rm -f '${AUTOSTART_FILE}'
        sleep 1

        echo "[STEP 4/5] Removing autostart helper script..."
        sudo rm -f '${HELPER_SCRIPT_PATH}'
        sleep 1

        echo "[STEP 5/5] Revoking passwordless permissions..."
        sudo rm -f '${SUDOERS_FILE}'
        sleep 1

        echo "---"
        echo "Cleanup complete. Shared folders are disabled."
        notify-send "Andromeda Shared Folders Disabled" --icon="folder"
        read -p "Press <Enter> to close this window."
EOF
)
    # Launch the terminal and execute the command block.
    kgx -- bash -c "$term_command"
}


# Function to start wofi
start_wofi() {
    # Start the background process to kill wofi on overview
    wofi_kill

    # --- Dynamic Option for Andromeda Shared Folders ---
    # Check if the autostart file exists to determine the current state.
    local andromeda_option_text
    if [ -f "$AUTOSTART_FILE" ]; then
        andromeda_option_text="7. Disable android-shared-folders"
    else
        andromeda_option_text="7. Enable android-shared-folders"
    fi

    # Options for the FastFLX1 tweaks menu, with the dynamic option
    OPTIONS="1. Switch environment (staging/production)\n2. Upgrade FuriOS\n3. Set city to Weather\n4. Manage Tweak services (start/stop)\n5. Manage Tweak services autostart\n6. Manage custom buttons options\n${andromeda_option_text}\n8. Quit"

    # Display the menu and capture the user's selection using wofi
    SELECTION=$(echo -e "$OPTIONS" | wofi -d --prompt "Select an option:" --lines 8)

    # Execute a command based on the selection
    case "$SELECTION" in
        "1. Switch environment (staging/production)")
            echo -e "1. Go to staging\n2. Go to production" | wofi -d --prompt "Select environment:" --lines 2 | {
                read env_choice
                case "$env_choice" in
                    "1. Go to staging")
                        kgx -- bash -c 'sudo apt install furios-apt-config-staging furios-apt-config-debian-staging -y && sudo apt update && sudo apt install furios-apt-config-krypton-staging -y && sudo apt update && sudo apt upgrade -y --allow-downgrades; read -p "Press <Enter> to close."'
                        ;;
                    "2. Go to production")
                        kgx -- bash -c 'sudo apt remove furios-apt-config-staging furios-apt-config-debian-staging furios-apt-config-krypton-staging -y && sudo apt update && sudo apt upgrade -y --allow-downgrades; read -p "Press <Enter> to close."'
                        ;;
                esac
            }
            ;;
        "2. Upgrade FuriOS")
            kgx -- bash -c 'sudo apt update && sudo apt upgrade -y --allow-downgrades; read -p "Press <Enter> to close."'
            ;;
        "3. Set city to Weather")
            pkill -x feh
            kgx -- bash -c 'gnome-weather-locations'
            ;;
        "4. Manage Tweak services (start/stop)")
            echo -e "1. Start Tweak services\n2. Stop Tweak services" | wofi -d --prompt "Select action:" --lines 2 | {
                read service_choice
                case "$service_choice" in
                    "1. Start Tweak services")
                        bash -c 'notify-send "Tweak services started" --icon="/home/furios/.git/fastflx1/files/fastflx1.svg" && dialtone & alarmvol & gen-thumbnails & gesture-shortcuts & vol-buttons & assistant-button-tweak'
                        ;;
                    "2. Stop Tweak services")
                        bash -c 'pkill -x "(vol-shortcuts|dialtone|alarmvol|gen-thumbnails|gesture-shortcuts|vol-buttons|assistant-button-tweak)" & pkill -x evremap & pkill -x lisgd && notify-send "Tweak services stopped" --icon="/home/furios/.git/fastflx1/files/fastflx1.svg"'
                        ;;
                esac
            }
            ;;
        "5. Manage Tweak services autostart")
            echo -e "1. Disable Tweak services autostart\n2. Re-enable Tweak services autostart" | wofi -d --prompt "Select action:" --lines 2 | {
                read autostart_choice
                case "$autostart_choice" in
                    "1. Disable Tweak services autostart")
                        autostart_dir="${HOME}/.config/autostart"
                        rm -f "${autostart_dir}/alarmvol.desktop" \
                                "${autostart_dir}/dialtone.desktop" \
                                "${autostart_dir}/gen-thumbnails.desktop" \
                                "${autostart_dir}/gesture-shortcuts.desktop" \
                                "${autostart_dir}/vol-buttons.desktop" \
                                "${autostart_dir}/evremap.desktop"
                        notify-send "Tweak services autostart disabled" --icon="/home/furios/.git/fastflx1/files/fastflx1.svg"
                        ;;
                    "2. Re-enable Tweak services autostart")
                        autostart_dir="${HOME}/.config/autostart"
                        cp "${HOME}/.git/fastflx1/configs/autostart/"{alarmvol.desktop,dialtone.desktop,gen-thumbnails.desktop,gesture-shortcuts.desktop,vol-buttons.desktop,evremap.desktop} "${autostart_dir}/"
                        notify-send "Tweak services autostart re-enabled" --icon="/home/furios/.git/fastflx1/files/fastflx1.svg"
                        ;;
                esac
            }
            ;;
        "6. Manage custom buttons options")
            echo -e "1. Disable custom assistant-button options\n2. Re-enable custom assistant-button options" | wofi -d --prompt "Select action:" --lines 2 | {
                read button_choice
                case "$button_choice" in
                    "1. Disable custom assistant-button options")
                        pkill -x vol-buttons
                        pkill -x assistant-button-tweak
                        pkill -x evremap
                        autostart_dir="${HOME}/.config/autostart"
                        assistant_button_dir="${HOME}/.config/assistant-button"
                        rm -f "${assistant_button_dir}/short_press" \
                                "${assistant_button_dir}/long_press" \
                                "${autostart_dir}/evremap.desktop" \
                                "${autostart_dir}/vol-buttons.desktop" \
                                "${assistant_button_dir}/double_press"
                        notify-send "Custom button options disabled" --icon="/home/furios/.git/fastflx1/files/fastflx1.svg"
                        ;;
                    "2. Re-enable custom assistant-button options")
                        autostart_dir="${HOME}/.config/autostart"
                        assistant_button_dir="${HOME}/.config/assistant-button"
                        mkdir -p "$autostart_dir" "$assistant_button_dir"
                        cp "${HOME}/.git/fastflx1/configs/autostart/"{vol-buttons.desktop,evremap.desktop} "${autostart_dir}/"
                        cp "${HOME}/.git/fastflx1/configs/assistant-button/"{short_press,double_press,long_press} "${assistant_button_dir}/"
                        notify-send "Custom assistant-button options re-enabled" --icon="/home/furios/.git/fastflx1/files/fastflx1.svg"
                        ;;
                esac
            }
            ;;
        "7. Enable android-shared-folders" | "7. Disable android-shared-folders")
            # This case handles both enabling and disabling.
            if [ -f "$AUTOSTART_FILE" ]; then
                # If the file exists, the feature is enabled, so we run the disable function.
                disable_sharing
            else
                # If the file doesn't exist, the feature is disabled, so we run the enable function.
                enable_sharing
            fi
            ;;
        "8. Quit")
            exit 0
            ;;
        *)
            # It's good practice to handle unexpected selections.
            echo "Invalid selection. Exiting."
            exit 1
            ;;
    esac
}

# --- Main Execution ---
# Kill any old wofi instances before starting a new one.
pkill -x wofi || true
# This seems to be a way to ensure the overview is not active before launching.
wtype -M win -k Super_l
# Start the main wofi menu function.
start_wofi