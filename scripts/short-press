#!/bin/bash

is_overview_active() {
    gdbus call --session \
        --dest org.gnome.Shell \
        --object-path /org/gnome/Shell \
        --method org.freedesktop.DBus.Properties.Get \
        org.gnome.Shell OverviewActive | grep -q "true"
}

unlocked() {
    wofi_kill &
	# Check if wofi is running
	if pgrep -x "wofi" > /dev/null; then
	# Wofi is running; simulate pressing Enter
        wtype -P 'return' -p 'return'
        exit 0
	fi

# Options for the wofi menu
OPTIONS="1. Copy Ctrl+C\n2. Paste Ctrl+V\n3. Cut Ctrl+X\n4. Paste to Terminal (Wl-paste)\n5. Select all & copy Ctrl+A Ctrl+C\n6. Kill active window\n7. Add last caller (or copied number) to contacts\n8. Close"

# Display the menu and capture the user's selection
SELECTION=$(echo -e "$OPTIONS" | wofi -d --prompt "Select an option:" --lines 8)

# Execute a command based on the selection
case "$SELECTION" in
    "1. Copy Ctrl+C")
        wtype -M ctrl c -m ctrl
        ;;
    "2. Paste Ctrl+V")
        wtype -M ctrl v -m ctrl
        ;;
    "3. Cut Ctrl+X")
        wtype -M ctrl x -m ctrl
        ;;
    "4. Paste to Terminal (Wl-paste)")
        clipboard_content=$(wl-paste)
        if [[ -z "$clipboard_content" ]]; then
            notify-send "Clipboard is empty."
            exit 1
        fi
        wtype "$clipboard_content"
        ;;
    "5. Select all & copy Ctrl+A Ctrl+C")
        wtype -M ctrl a -m ctrl && wtype -M ctrl c -m ctrl
        ;;
    "6. Kill active window")
        wtype -M alt -P F4 -m alt -p F4
        ;;
    "7. Add last caller (or copied number) to contacts")
    # Check if clipboard contains a valid phone number (numbers only or starts with + followed by digits)
    CLIPBOARD_CONTENT=$(wl-paste)
    
    # Regular expression to match valid phone numbers (numbers only or + followed by digits)
    if [[ ! "$CLIPBOARD_CONTENT" =~ ^[+]?[0-9]+$ ]]; then
        # If clipboard content is invalid or empty, show a notification and exit
        notify-send "Not proceeding - fix your clipboard" --icon="/home/furios/.git/fastflx1/files/fastflx1.svg"
        return 1
    fi

    # Kill gnome-contacts if it's already running
    if pgrep -x "gnome-contacts" > /dev/null; then
        killall gnome-contacts
        sleep 1  # Wait for it to terminate
    fi

    # Open gnome-contacts
    gnome-contacts &

    # Wait for gnome-contacts to launch
    sleep 1.7

    # Simulate "Ctrl+N" to open a new contact tab
    wtype -M ctrl -P n -m ctrl
    sleep 0.3

    # Simulate pressing "Tab" four times to navigate through the fields
    wtype -P tab
    wtype -P tab
    wtype -P tab
    wtype -P tab

    # Simulate "Ctrl+V" to paste content (the phone number)
    wtype -M ctrl -P v -m ctrl
        ;;
    "8. Close")
        pkill -x wofi
        ;;
esac

}

# Function to toggle feedback profile
locked() {
	# Find current feedback profile
	current_profile=$(gsettings get org.sigxcpu.feedbackd profile | tr -d "'")

	# Give index numbers to profiles
	profiles=("full" "quiet" "silent")

	# Find the index of the current profile

	for i in "${!profiles[@]}"; do

	if [[ "${profiles[$i]}" == "$current_profile" ]]; then

	current_index=$i

	break

	fi
	
	done

	# Calculate the next profile index (cycling back to 0 after the last one)

	next_index=$(( (current_index + 1) % ${#profiles[@]} ))

	# Set the next profile

	gsettings set org.sigxcpu.feedbackd profile "${profiles[$next_index]}"
}

wofi_kill () {
dbus-monitor "interface='org.freedesktop.DBus.Properties',member='PropertiesChanged',path='/org/gnome/Shell'" | \
while read -r line; do
    # Check if the OverviewActive property has changed
    if echo "$line" | grep -q "string \"OverviewActive\""; then
        # Read the next line for the boolean value
        read -r next_line
        if echo "$next_line" | grep -q "boolean true"; then
            if pgrep -x wofi > /dev/null; then
          pkill -x wofi
        fi
            break
        fi
    fi
done
}

# Identify the session ID
session_id=$(loginctl list-sessions | grep $(whoami) | awk 'NR==2 {print $1}')
# Check lock status of the session
idle_hint=$(loginctl show-session $session_id -p LockedHint)

if [[ "$idle_hint" == *"yes"* ]]; then
    locked
    echo "Locked"
elif [[ "$idle_hint" == *"no"* ]]; then
    if is_overview_active; then
        pkill -x wofi
        wtype -M win -k Super_l
        unlocked
    else
        unlocked
    fi
else 
    echo "Failed to determine lockscreen state"
fi