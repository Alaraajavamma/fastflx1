#!/bin/bash

unlocked() {
# Check if wofi is running
	if pgrep -x "wofi" > /dev/null; then
	# Wofi is running; simulate pressing Enter
        pkill -x wofi
	fi
    
# Options for the wofi menu
most_ram_apps=$(ps --sort=-%mem -eo comm | head -n 6 | awk 'NR>1')
OPTIONS="1. Back (XF86Back)
3. Kill RAM-eater #1 (Name: $(echo "$most_ram_apps" | sed -n '1p'))
3. Kill RAM-eater #2 (Name: $(echo "$most_ram_apps" | sed -n '1p'))
4. Kill RAM-eater #3 (Name: $(echo "$most_ram_apps" | sed -n '2p'))
5. Kill RAM-eater #4 (Name: $(echo "$most_ram_apps" | sed -n '3p'))
6. Kill RAM-eater #5 (Name: $(echo "$most_ram_apps" | sed -n '4p'))
7. Kill RAM-eater #6 (Name: $(echo "$most_ram_apps" | sed -n '5p'))
8. Close"

# Display the menu and capture the user's selection
SELECTION=$(echo -e "$OPTIONS" | wofi -d --prompt "Select an option:" --lines 8)

# Execute a command based on the selection
case "$SELECTION" in
    "1. Back (XF86Back)")
        wtype -k XF86Back
        ;;
    "2. Kill RAM-eater #1 (Name: $(echo "$most_ram_apps" | sed -n '1p'))")
	pid=$(ps --sort=-%mem -eo pid | sed -n '1p')
        [[ -n "$pid" ]] && kill "$pid" && notify-send "Killed process $pid"
        ;;
    "3. Kill most RAM-eater #2 (Name: $(echo \"$most_ram_apps\" | sed -n '1p'))")
        pid=$(ps --sort=-%mem -eo pid | sed -n '2p')
        [[ -n "$pid" ]] && kill "$pid" && notify-send "Killed process $pid"
        ;;
    "4. Kill most RAM-eater #3 (Name: $(echo \"$most_ram_apps\" | sed -n '2p'))")
        pid=$(ps --sort=-%mem -eo pid | sed -n '3p')
        [[ -n "$pid" ]] && kill "$pid" && notify-send "Killed process $pid"
        ;;
    "5. Kill most RAM-eater #4 (Name: $(echo \"$most_ram_apps\" | sed -n '3p'))")
        pid=$(ps --sort=-%mem -eo pid | sed -n '4p')
        [[ -n "$pid" ]] && kill "$pid" && notify-send "Killed process $pid"
        ;;
    "6. Kill most RAM-eater #5 (Name: $(echo \"$most_ram_apps\" | sed -n '4p'))")
        pid=$(ps --sort=-%mem -eo pid | sed -n '5p')
        [[ -n "$pid" ]] && kill "$pid" && notify-send "Killed process $pid"
        ;;
    "7. Kill most RAM-eater #6 (Name: $(echo \"$most_ram_apps\" | sed -n '5p'))")
        pid=$(ps --sort=-%mem -eo pid | sed -n '6p')
        [[ -n "$pid" ]] && kill "$pid" && notify-send "Killed process $pid"
        ;;
    "8. Close")
        pkill -x wofi
        ;;
esac

}

locked() {

# List of processes that should not be killed (case insensitive)
EXCLUDE_PROCESSES=("systemd" "bash" "sshd" "phosh")

# Resource thresholds (customize as needed)
CPU_THRESHOLD=80  # Percentage
MEM_THRESHOLD=80  # Percentage

# Function to check if a process is in the exclusion list
is_excluded() {
    local process_name=$1
    for excluded in "${EXCLUDE_PROCESSES[@]}"; do
        if [[ "${process_name,,}" == "${excluded,,}" ]]; then
            return 0
        fi
    done
    return 1
}

# Main function
check_and_kill() {
    # Get processes sorted by resource usage
    # Using `ps` to fetch CPU and memory usage
    ps -eo pid,comm,%cpu,%mem --sort=-%cpu,-%mem | while read -r pid name cpu mem; do
        # Skip header line
        if [[ "$pid" == "PID" ]]; then
            continue
        fi

        # Skip excluded processes
        if is_excluded "$name"; then
            continue
        fi

        # Kill process if it exceeds thresholds
        if (( $(echo "$cpu > $CPU_THRESHOLD" | bc -l) || $(echo "$mem > $MEM_THRESHOLD" | bc -l) )); then
            echo "Killing process $name (PID: $pid, CPU: $cpu%, MEM: $mem%)"
            kill -9 "$pid" || echo "Failed to kill $name (PID: $pid)"
        fi
    done
}

# Run the main function
check_and_kill
	
}


# Identify the session ID
session_id=$(loginctl list-sessions | grep $(whoami) | awk 'NR==2 {print $1}')
# Check lock status of the session
idle_hint=$(loginctl show-session $session_id -p LockedHint)

if [[ "$idle_hint" == *"yes"* ]]; then
    locked
    echo "Locked"
elif [[ "$idle_hint" == *"no"* ]]; then
    unlocked
    echo "Unlocked"
else 
    echo "Failed to determine lockscreen state"
fi
