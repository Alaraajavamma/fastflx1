#!/bin/bash

# Create the destination directory for thumbnails if it doesn't exist
THUMBNAIL_DIR="$HOME/.cache/thumbnails/normal"
mkdir -p "$THUMBNAIL_DIR"

# Function to remove spaces from filenames
remove_spaces_from_filename() {
    local FILE="$1"
    local DIR=$(dirname "$FILE")
    local BASENAME=$(basename "$FILE")
    local CLEANED_NAME=$(echo "$BASENAME" | tr -d ' ')
    local NEW_FILE="$DIR/$CLEANED_NAME"

    if [[ "$FILE" != "$NEW_FILE" ]]; then
        mv "$FILE" "$NEW_FILE" && echo "Renamed: $FILE -> $NEW_FILE"
    fi

    echo "$NEW_FILE" # Return the new file name
}

# Function to generate a thumbnail for a given image
generate_thumbnail() {
    local IMAGE="$1"
    local HASH=$(echo -n "file://$IMAGE" | md5sum | cut -d' ' -f1)
    local THUMBNAIL_FILE="$THUMBNAIL_DIR/${HASH}.png"

    if [ ! -f "$THUMBNAIL_FILE" ]; then
        if [ -f "$IMAGE" ]; then  # Ensure the file exists
            # Attempt to generate a thumbnail
            if ! convert "$IMAGE" -thumbnail 128x128 PNG24:"$THUMBNAIL_FILE"; then
                # Error occurred during thumbnail generation
                echo "Error generating thumbnail for: $IMAGE"
                local DIR=$(dirname "$IMAGE")
                local BASENAME=$(basename "$IMAGE")

                # Toggle suffix between _tnfix and _tnf to ensure the name changes
                if [[ "$BASENAME" == *_tnfix.* ]]; then
                    local ERROR_FILE="${DIR}/${BASENAME%_tnfix.*}_tnf.${BASENAME##*.}"
                elif [[ "$BASENAME" == *_tnf.* ]]; then
                    local ERROR_FILE="${DIR}/${BASENAME%_tnf.*}_tnfix.${BASENAME##*.}"
                else
                    local ERROR_FILE="${DIR}/${BASENAME%.*}_tnfix.${BASENAME##*.}"
                fi

                mv "$IMAGE" "$ERROR_FILE"
                echo "File renamed due to error: $IMAGE -> $ERROR_FILE"
                return 1
            fi

            # Attempt to set metadata
            if ! mogrify -set "Thumb::URI" "file://$IMAGE" -set "Thumb::MTime" "$(stat -c %Y "$IMAGE")" "$THUMBNAIL_FILE"; then
                # Error occurred during metadata setting
                echo "Error setting metadata for: $IMAGE"
                local DIR=$(dirname "$IMAGE")
                local BASENAME=$(basename "$IMAGE")

                # Toggle suffix between _tnfix and _tnf to ensure the name changes
                if [[ "$BASENAME" == *_tnfix.* ]]; then
                    local ERROR_FILE="${DIR}/${BASENAME%_tnfix.*}_tnf.${BASENAME##*.}"
                elif [[ "$BASENAME" == *_tnf.* ]]; then
                    local ERROR_FILE="${DIR}/${BASENAME%_tnf.*}_tnfix.${BASENAME##*.}"
                else
                    local ERROR_FILE="${DIR}/${BASENAME%.*}_tnfix.${BASENAME##*.}"
                fi

                mv "$IMAGE" "$ERROR_FILE"
                echo "File renamed due to error: $IMAGE -> $ERROR_FILE"
                return 1
            fi

            echo "Thumbnail generated for: $IMAGE"
        fi
    else
        echo "Thumbnail already exists for: $IMAGE"
    fi
}

# Function to delete a thumbnail for a given image
delete_thumbnail() {
    local IMAGE="$1"
    local HASH=$(echo -n "file://$IMAGE" | md5sum | cut -d' ' -f1)
    local THUMBNAIL_FILE="$THUMBNAIL_DIR/${HASH}.png"

    if [ -f "$THUMBNAIL_FILE" ]; then
        rm -f "$THUMBNAIL_FILE"
        echo "Thumbnail deleted for: $IMAGE"
    else
        echo "No thumbnail found for: $IMAGE"
    fi
}

# Initial cleanup: remove spaces from filenames
find "$HOME" -type d -path "$HOME/.*" -prune -o -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" -o -iname "*.bmp" -o -iname "*.tiff" \) -print | while read -r FILE; do
    CLEANED_FILE=$(remove_spaces_from_filename "$FILE")
    generate_thumbnail "$CLEANED_FILE"
done

# Monitor for file events using inotifywait, excluding hidden directories
inotifywait -m -r --exclude '^.*/\..*' -e create -e delete -e moved_to -e moved_from --format '%e %w%f' "$HOME" | while read -r EVENT FILE; do
    case "$EVENT" in
        CREATE|MOVED_TO)
            if [[ "$FILE" =~ \.(jpg|jpeg|png|gif|bmp|tiff)$ ]]; then
                CLEANED_FILE=$(remove_spaces_from_filename "$FILE")
                echo "File created or moved to: $CLEANED_FILE"
                generate_thumbnail "$CLEANED_FILE"
            fi
            ;;
        DELETE|MOVED_FROM)
            if [[ "$FILE" =~ \.(jpg|jpeg|png|gif|bmp|tiff)$ ]]; then
                echo "File deleted or moved from: $FILE"
                delete_thumbnail "$FILE"
            fi
            ;;
    esac
done

