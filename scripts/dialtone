#!/bin/bash

# Global variable to determine if we should exit volume adjustment
should_exit_adjust_volume=false

# Function to monitor for incoming calls
monitor() {
    echo "Starting call monitor..."
    dbus-monitor --system "interface='org.freedesktop.ModemManager1.Modem.Voice',type='signal',member='CallAdded'" |
    while read -r line; do
        if [[ "$line" == *"CallAdded"* ]]; then
            echo "Call detected. Checking call direction..."
            direct
        fi
    done
}

# Function to monitor call direction (outgoing or incoming)
direct() {
    last_line=$(mmcli -m any --voice-list-calls | tail -n 1)

    if [[ $(echo "$last_line" | awk '{print $(NF-1)}') == "outgoing" ]]; then
        echo "The call is outgoing. Proceeding with further steps..."
        changes & 
        adjust_volume
    else
        echo "The call is not outgoing. No action taken."
        adjust_volume
    fi
}

# Function to monitor CallDeleted signal and restart monitoring
monitor_call_deleted() {
    dbus-monitor --system "interface='org.freedesktop.ModemManager1.Modem.Voice',type='signal',member='CallDeleted'" |
    while read -r line; do
        if [[ "$line" == *"CallDeleted"* ]]; then
            echo "Call deleted. Restarting monitoring..."
            should_exit_adjust_volume=true  # Set the flag to stop adjusting volume
            pkill -P $$  # Kill this instance of the monitor
            monitor &  # Start a new monitoring instance in the background
            return
        fi
    done &
}

# Function to adjust volume based on speaker mode (earpiece or speaker)
adjust_volume() {
    local last_speaker_status=""

    # Monitor D-Bus for changes to the speaker mode
    dbus-monitor --session "interface='org.mobian_project.CallAudio'" | while read line; do
        if echo "$line" | grep -q "member=EnableSpeaker"; then
            # If the flag is set, exit the function
            if [ "$should_exit_adjust_volume" = true ]; then
                echo "Exiting volume adjustment due to CallDeleted signal."
                break
            fi
            
            speaker_status=$(echo "$line" | grep -oP 'boolean \K\w+')

            if [[ "$speaker_status" != "$last_speaker_status" ]]; then
                if [[ "$speaker_status" == "true" ]]; then
                    echo "Speaker mode enabled. Ensuring maximum volume..."
                    for i in {1..5}; do
                        wtype -k XF86AudioRaiseVolume
                    done
                elif [[ "$speaker_status" == "false" ]]; then
                    echo "Speaker mode disabled (earpiece mode). Adjusting to 40% volume..."
                    for i in {1..5}; do
                        wtype -k XF86AudioLowerVolume
                    done
                    for i in {1..2}; do
                        wtype -k XF86AudioRaiseVolume
                    done
                fi
                last_speaker_status="$speaker_status"
            else
                echo "Speaker mode unchanged. No adjustment needed."
            fi
        fi
    done
}

# Function to monitor for call changes and handle feedback
changes() {
    feedbackd_profile=$(gsettings get org.sigxcpu.feedbackd profile | tr -d "'")
    
    while true; do
        last_line=$(mmcli -m any --voice-list-calls | tail -n 1)
        status_word=$(echo "$last_line" | awk '{print $NF}' | tr -d '()')

        if [[ "$status_word" == "active" || "$status_word" == "activeaccepted" ]]; then
            echo "The call status is active. Updating feedback profile..."
            gsettings set org.sigxcpu.feedbackd profile silent
            break
        elif mmcli -m any --voice-list-calls | grep -q "No calls were found"; then
            gsettings set org.sigxcpu.feedbackd profile "$feedbackd_profile"
            break
        else
            cd /sys/class/leds/vibrator && echo 50 > duration && echo 1 > activate
            echo 12 > /sys/class/leds/green/brightness
            sleep 0.5
            echo 0 > /sys/class/leds/green/brightness
        fi
    done

    gsettings set org.sigxcpu.feedbackd profile "$feedbackd_profile"
}

# Set trap to cleanly exit
trap "pkill -P $$; exit" SIGINT SIGTERM

# Start monitoring for calls
monitor &  # Start the calling monitoring process in the background
monitor_call_deleted  # Start watching for CallDeleted signals
wait  # Wait for background jobs to finish