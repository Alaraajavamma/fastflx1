#!/bin/bash

# Monitor for calls
monitor() {
    dbus-monitor --system "interface='org.freedesktop.ModemManager1.Modem.Voice',type='signal',member='CallAdded'" |
    while read -r line; do
        if echo "$line" | grep -qE "^signal.*CallAdded"; then
            echo "Call detected. Checking call id..."
            callid
        fi
    done
}

#Monitor callid so we can check phonenumber and call state 
callid() { TIME=$(date +"%H:%M")
    DAY=$(date +"%-d.%-m.")
    VOICECALLID="$(
    output=$(mmcli -m any --voice-list-calls)
    number=$(echo "$output" | awk -F'/Call/' '{print $2}' | awk '{print $1}')
    echo $number
)"
phone
}

# Monitor other party's phone number
phone() {
    PHONENUMBER="$(mmcli -m any -o "$VOICECALLID" -K | \
        grep call.properties.number | \
        cut -d ':' -f2 | \
        tr -d '[:space:]')"  # Remove all spaces and newlines

    # Ensure no extra newlines or spaces and copy it to clipboard
    echo -n "$PHONENUMBER" | wl-copy  # Use -n to avoid echoing an additional newline 
}


# Main script
monitor