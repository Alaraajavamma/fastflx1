#!/bin/bash

# Monitor for incoming calls
monitor() {
    dbus-monitor --system "interface='org.freedesktop.ModemManager1.Modem.Voice',type='signal',member='CallAdded'" |
    while read -r line; do
        if echo "$line" | grep -qE "^signal.*CallAdded"; then
            echo "Call detected. Checking call direction..."
            direct
        fi
    done
}

# Monitor call direction (outgoing or incoming)
direct() {
    # Run the command and get the last line
    last_line=$(mmcli -m any --voice-list-calls | tail -n 1)

    # Check if the second-last word is "outgoing"
    if [[ $(echo "$last_line" | awk '{print $(NF-1)}') == "outgoing" ]]; then
        echo "The call is outgoing. Proceeding with further steps..."
        changes & 
        adjust_volume
    else
        echo "The call is not outgoing. No action taken."
        adjust_volume
    fi
}

adjust_volume() {
    # Variable to store the last known speaker mode and call status
    last_speaker_status=""
    call_active="false"

    # Monitor D-Bus for changes to the speaker mode and call state
    dbus-monitor --session "interface='org.mobian_project.CallAudio'" | while read line; do
        # Check if the line indicates the start or end of a call (SelectMode)
        if echo "$line" | grep -q "member=SelectMode"; then
            # Extract the call state (1 means call active, 0 means call ended)
            call_state=$(echo "$line" | grep -oP 'uint32 \K\d+')

            if [[ "$call_state" == "1" ]]; then
                # Call is active, so allow volume adjustments
                call_active="true"
                echo "Call is active. Volume adjustments enabled."
            elif [[ "$call_state" == "0" ]]; then
                # Call has ended, stop any volume adjustments
                call_active="false"
                echo "Call ended. Volume adjustments disabled."
            fi
        fi

        # Only proceed with speaker mode changes if a call is active
        if [[ "$call_active" == "true" ]]; then
            # Check if the line indicates a speaker mode change (EnableSpeaker)
            if echo "$line" | grep -q "member=EnableSpeaker"; then
                # Extract the boolean value (true or false) from the output
                speaker_status=$(echo "$line" | grep -oP 'boolean \K\w+')

                # Check if the mode has changed
                if [[ "$speaker_status" != "$last_speaker_status" ]]; then
                    if [[ "$speaker_status" == "true" ]]; then
                        echo "Speaker mode enabled. Ensuring maximum volume..."
                        for i in {1..5}; do
                            wtype -k XF86AudioRaiseVolume
                        done
                    elif [[ "$speaker_status" == "false" ]]; then
                        echo "Speaker mode disabled (earpiece mode). Adjusting to 40% volume..."
                        for i in {1..5}; do
                            wtype -k XF86AudioLowerVolume
                        done
                        for i in {1..2}; do
                            wtype -k XF86AudioRaiseVolume
                        done
                    else
                        echo "Unknown speaker status. Continuing..."
                    fi

                    # Update the last known status
                    last_speaker_status="$speaker_status"
                else
                    echo "Speaker mode unchanged. No adjustment needed."
                fi
            fi
        fi
    done
}

# Monitor for call changes
changes() {
    feedbackd_profile=$(gsettings get org.sigxcpu.feedbackd profile | tr -d "'")

    while true; do
        # Run the command and get the last line (updated in each loop iteration)
        last_line=$(mmcli -m any --voice-list-calls | tail -n 1)
        status_word=$(echo "$last_line" | awk '{print $NF}' | tr -d '()')

        if [[ "$status_word" == "active" || "$status_word" == "activeaccepted" ]]; then
            echo "The call status is active. Proceeding with further steps..."
            gsettings set org.sigxcpu.feedbackd profile silent
            break  # Exit the loop as the call has been accepted
        elif [[ $(mmcli -m any --voice-list-calls) == *"No calls were found"* ]]; then
            gsettings set org.sigxcpu.feedbackd profile "$feedbackd_profile"
            break
        else
            # Vibrate and blink led if call is not yet active
            cd /sys/class/leds/vibrator && echo 50 > duration && echo 1 > activate
            echo 12 > /sys/class/leds/green/brightness
            sleep 0.5  # Shorter interval for faster vibration response
            echo 0 > /sys/class/leds/green/brightness
        fi
    done

    # Restore profile after exiting the loop
    gsettings set org.sigxcpu.feedbackd profile "$feedbackd_profile"
}

# Main script
monitor
