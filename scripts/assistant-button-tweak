#!/bin/bash

# Start evremap in the background
evremap remap ~/.config/evremap/remap.toml &

# Replace with the correct device path for your button
device="/dev/input/event4"  # Change eventX to your device
keycode=112  # Keycode to monitor

# Timeout threshold in milliseconds
timeout_threshold=500
long_press_threshold=1000  # 1 second in milliseconds

# Variables to track quick presses
press_count=0
window_start=0
press_detected=0  # Tracks if a press has occurred
long_press_detected=0  # Tracks if a long press occurred
long_press_timer=0  # PID of the long press timer

# Start evtest and filter button events for keycode 112
evtest "$device" | while read -r line; do
    # Extract the key code and value from the event
    key_code=$(echo "$line" | grep -oP 'code \K[0-9]+')
    key_value=$(echo "$line" | grep -oP 'value \K[0-9]+')

    # Check if the event is for keycode 112
    if [ "$key_code" == "$keycode" ]; then
        if [ "$key_value" -eq 1 ]; then
            # Detect press (value 1)
            press_detected=1  # Mark that a press has occurred
            long_press_detected=0  # Reset long press detection
            press_time=$(date +%s%3N)  # Capture press timestamp in milliseconds

            # Start long press timer
            long_press_timer=$(echo "$(date +%s%3N) + $long_press_threshold" | bc)
        elif [ "$key_value" -eq 0 ] && [ "$press_detected" -eq 1 ]; then
            # Detect release (value 0) after a press
            release_time=$(date +%s%3N)
            press_detected=0  # Reset press detection

            # Check if it was a long press
            if [ "$release_time" -ge "$long_press_timer" ]; then
                long-press &
                continue  # Skip quick press handling for long presses
            fi

            if [ -z "$window_start" ] || [ $((release_time - window_start)) -gt "$timeout_threshold" ]; then
                # Start a new counting window
                press_count=1
                window_start=$release_time
            else
                # Increment within the current window
                press_count=$((press_count + 1))
            fi

            # Schedule evaluation after 500ms
            if [ -n "$timer_pid" ]; then
                kill "$timer_pid" 2>/dev/null
            fi

            (
                sleep 0.5
                case "$press_count" in
                    1) short-press ;;
                    2) double-press ;;
                    3) echo "three-press" ;;
                    *) echo "$press_count-presses" ;;
                esac
                press_count=0
                window_start=0
            ) &
            timer_pid=$!
        fi
    fi
done
