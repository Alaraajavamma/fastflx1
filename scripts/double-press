#!/bin/bash

is_overview_active() {
    gdbus call --session \
        --dest org.gnome.Shell \
        --object-path /org/gnome/Shell \
        --method org.freedesktop.DBus.Properties.Get \
        org.gnome.Shell OverviewActive | grep -q "true"
}

unlocked() {
    wofi_kill &
	# Check if wofi is running
	if pgrep -x "wofi" > /dev/null; then
	# Wofi is running; simulate pressing Enter
        pkill -x wofi
	fi
	
# Options for the wofi menu
OPTIONS="1. Take screenshot\n2. Take picture \n3. Scale display to 300%\n4. Scale display to 200%\n5. Scale display to 150%\n6. Scale-to-fit true\n7. Scale-to-fit false\n8. Close"

# Display the menu and capture the user's selection
SELECTION=$(echo -e "$OPTIONS" | wofi -d --prompt "Select an option:" --lines 8)

# Execute a command based on the selection
case "$SELECTION" in
    "1. Take screenshot")
        take_screenshot &
        pkill -x wofi
        ;;
    "2. Take picture")
        take_picture
        ;;
    "3. Scale display to 300%")
        wlr-randr --output "HWCOMPOSER-1" --scale 3.00
        ;;
    "4. Scale display to 200%")
        wlr-randr --output "HWCOMPOSER-1" --scale 2.00
        ;;
    "5. Scale display to 150%")
        wlr-randr --output "HWCOMPOSER-1" --scale 1.50
        ;;
    "6. Scale-to-fit true")
        gsettings set sm.puri.phoc scale-to-fit true
        ;;
    "7. Scale-to-fit false")
        gsettings set sm.puri.phoc scale-to-fit false
        ;;
    "8. Close")
        pkill -x wofi
        ;;
esac

}

# Function to toggle the flashlight
locked() {
    current_brightness=$(dbus-send --session --dest=org.droidian.Flashlightd --print-reply=literal \
                    /org/droidian/Flashlightd org.freedesktop.DBus.Properties.Get \
                    string:org.droidian.Flashlightd string:Brightness | awk '{print $3}')

    if [ "$current_brightness" -eq 0 ]; then
        # Turn on the flashlight
        dbus-send --session --dest=org.droidian.Flashlightd --type=method_call /org/droidian/Flashlightd org.droidian.Flashlightd.SetBrightness uint32:31
        echo "Flashlight turned on"
	sleep 20
        dbus-send --session --dest=org.droidian.Flashlightd --type=method_call /org/droidian/Flashlightd org.droidian.Flashlightd.SetBrightness uint32:0
    else
        # Turn off the flashlight
        dbus-send --session --dest=org.droidian.Flashlightd --type=method_call /org/droidian/Flashlightd org.droidian.Flashlightd.SetBrightness uint32:0
        echo "Flashlight turned off"
    fi
}

wofi_kill () {
dbus-monitor "interface='org.freedesktop.DBus.Properties',member='PropertiesChanged',path='/org/gnome/Shell'" | \
while read -r line; do
    # Check if the OverviewActive property has changed
    if echo "$line" | grep -q "string \"OverviewActive\""; then
        # Read the next line for the boolean value
        read -r next_line
        if echo "$next_line" | grep -q "boolean true"; then
            if pgrep -x wofi > /dev/null; then
          pkill -x wofi
        fi
            break
        fi
    fi
done
}

take_picture() {
    # Set up directory
    HOME_DIR="$HOME"
    PICTURES_DIR="$HOME_DIR/Pictures"
    mkdir -p "$PICTURES_DIR"

    # Get current date and time for filename
    DATETIME=$(date +"photo_%Y%m%d_%H%M%S")
    FILENAME="$PICTURES_DIR/$DATETIME.jpeg"

    # Command to take picture
    gst-launch-1.0 -e \
      droidcamsrc camera-device=0 mode=2 ! \
      videoconvert ! \
      videoflip video-direction=8 ! \
      jpegenc snapshot=true ! \
      filesink location="$FILENAME"

    # Notify user
    if [ $? -eq 0 ]; then
      echo "Picture saved to: $FILENAME"
      command -v notify-send >/dev/null && notify-send "Picture Taken" "Saved to $FILENAME" --icon="/home/furios/.git/fastflx1/files/fastflx1.svg"
    else
      echo "Failed to take picture."
    fi
}

take_screenshot() {
    sleep 1
    SCREENSHOT_PATH="$(xdg-user-dir PICTURES)/Screenshot-$(date +%F-%T).png"
    gdbus call --session --dest org.gnome.Shell.Screenshot \
      --object-path /org/gnome/Shell/Screenshot \
      --method org.gnome.Shell.Screenshot.Screenshot \
      true false "$SCREENSHOT_PATH" &

    # Notify user
    if [ $? -eq 0 ]; then
      echo "Screenshot saved to: $SCREENSHOT_PATH"
      command -v notify-send >/dev/null && notify-send "Screenshot Taken" "Saved to $SCREENSHOT_PATH" --icon="/home/furios/.git/fastflx1/files/fastflx1.svg"
    else
      echo "Failed to take screenshot."
    fi
}


# Identify the session ID
session_id=$(loginctl list-sessions | grep $(whoami) | awk 'NR==2 {print $1}')
# Check lock status of the session
idle_hint=$(loginctl show-session $session_id -p LockedHint)

if [[ "$idle_hint" == *"yes"* ]]; then
    locked
    echo "Locked"
elif [[ "$idle_hint" == *"no"* ]]; then
    if is_overview_active; then
        pkill -x wofi
        wtype -M win -k Super_l
        unlocked
    else
        unlocked
    fi
else 
    echo "Failed to determine lockscreen state"
fi
