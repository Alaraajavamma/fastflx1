#!/bin/bash

# A script to manage a two-way, ACL-permissioned mirror between Linux and
# Andromeda. This script is intended to be run as root by a launcher
# (e.g., using pkexec) or with sudo.

# --- Configuration ---

# This block robustly determines the original user who launched the script,
# whether it was via 'pkexec' (for the graphical launcher) or 'sudo'.
if [ -n "$PKEXEC_UID" ]; then
    HOST_USER=$(getent passwd "$PKEXEC_UID" | cut -d: -f1)
elif [ -n "$SUDO_USER" ]; then
    HOST_USER="$SUDO_USER"
else
    # This error will trigger if script is run as root directly without a launcher
    echo "ERROR: Could not determine the original user. Please run via the launcher or 'sudo'." >&2
    exit 1
fi

HOST_HOME=$(getent passwd "$HOST_USER" | cut -d: -f6)
ANDROID_UID=1023
PID_FILE="/tmp/andromeda_permission_guardian.pid"

# --- Mirror: Linux -> Android ---
LINUX_SHARE_DIR_NAME="Linux-Share"
LINUX_DIRECTORIES_TO_SHARE=( "Downloads" "Music" "Documents" "Videos" "Pictures" )
ANDROID_MOUNT_TARGET_FOR_LINUX="${HOST_HOME}/.local/share/andromeda/data/media/0/${LINUX_SHARE_DIR_NAME}"

# --- Mirror: Android -> Linux ---
ANDROID_SHARE_DIR_NAME="Android-Share"
ANDROID_DIRECTORIES_TO_SHARE=( "DCIM" "Pictures" "Videos" "Documents" "Music" "Download" )
HOST_MOUNT_TARGET_FOR_ANDROID="${HOST_HOME}/${ANDROID_SHARE_DIR_NAME}"
ANDROID_STORAGE_SOURCE="${HOST_HOME}/.local/share/andromeda/data/media/0"

# --- Style and Helpers ---
C_GREEN="\033[1;32m"; C_RED="\033[1;31m"; C_RESET="\03S[0m"
log() { echo -e "${C_GREEN}[$(date +'%T')]${C_RESET} $1"; }
error() { echo -e "${C_RED}ERROR:${C_RESET} $1" >&2; }

# --- Core Functions ---
run_permission_guardian() {
    log "Permissions Guardian: Starting..."
    local watch_dirs=("$HOST_MOUNT_TARGET_FOR_ANDROID")
    for dir in "${LINUX_DIRECTORIES_TO_SHARE[@]}"; do watch_dirs+=("$HOST_HOME/$dir"); done

    log "Permissions Guardian: Performing initial permission sync..."
    for dir in "${watch_dirs[@]}"; do
        if [ -d "$dir" ]; then
            setfacl -R \
                -m "user:${HOST_USER}:rwx" -m "d:user:${HOST_USER}:rwx" \
                -m "user:${ANDROID_UID}:rwx" -m "d:user:${ANDROID_UID}:rwx" \
                "$dir"
        fi
    done
    log "Permissions Guardian: Initial sync complete. Monitoring for new files..."
    inotifywait -m -r -q -e create -e moved_to --format '%w%f' "${watch_dirs[@]}" | while read -r NEW_FILE_PATH; do
        log "Permissions Guardian: New item detected: ${NEW_FILE_PATH}"
        setfacl -m "user:${HOST_USER}:rwx" -m "user:${ANDROID_UID}:rwx" "${NEW_FILE_PATH}"
        log "Permissions Guardian: Permissions fixed for new item."
    done
}

do_start() {
    log "--- Starting Andromeda Two-Way Share ---"
    do_stop >/dev/null 2>&1
    log "Host User: ${HOST_USER} | Andromeda UID: ${ANDROID_UID}"

    log "Setting up: Linux -> Android"
    mkdir -p "$ANDROID_MOUNT_TARGET_FOR_LINUX"
    chown "${ANDROID_UID}:${ANDROID_UID}" "$ANDROID_MOUNT_TARGET_FOR_LINUX"
    for dir in "${LINUX_DIRECTORIES_TO_SHARE[@]}"; do
        local source_path="$HOST_HOME/$dir"; local target_path="$ANDROID_MOUNT_TARGET_FOR_LINUX/$dir"
        if [ -d "$source_path" ]; then
            log "  -> Mounting ${dir}..."
            mkdir -p "$target_path"
            chown "${ANDROID_UID}:${ANDROID_UID}" "$target_path"
            mount --bind "$source_path" "$target_path"
        fi
    done

    log "Setting up: Android -> Linux"
    su -c "mkdir -p '$HOST_MOUNT_TARGET_FOR_ANDROID'" "$HOST_USER"
    for dir in "${ANDROID_DIRECTORIES_TO_SHARE[@]}"; do
        local source_path="$ANDROID_STORAGE_SOURCE/$dir"; local target_path="$HOST_MOUNT_TARGET_FOR_ANDROID/$dir"
        if [ -d "$source_path" ]; then
            log "  -> Mounting ${dir}..."
            su -c "mkdir -p '$target_path'" "$HOST_USER"
            mount --bind "$source_path" "$target_path"
        fi
    done

    log "Launching Permissions Guardian in the background..."
    run_permission_guardian &
    echo $! > "$PID_FILE"
    log "--- Share Setup Complete ---"
}

do_stop() {
    log "--- Stopping Andromeda Two-Way Share ---"
    if [ -f "$PID_FILE" ]; then
        local pid_to_kill=$(cat "$PID_FILE")
        log "Stopping Permissions Guardian (PID: ${pid_to_kill})...";
        pkill -P "$pid_to_kill" &>/dev/null || true
        kill "$pid_to_kill" &>/dev/null || true
        rm -f "$PID_FILE"
    fi

    log "Unmounting all shared directories..."
    for dir in "${LINUX_DIRECTORIES_TO_SHARE[@]}"; do umount "$ANDROID_MOUNT_TARGET_FOR_LINUX/$dir" &>/dev/null || true; done
    umount "$ANDROID_MOUNT_TARGET_FOR_LINUX" &>/dev/null || true
    
    for dir in "${ANDROID_DIRECTORIES_TO_SHARE[@]}"; do umount "$HOST_MOUNT_TARGET_FOR_ANDROID/$dir" &>/dev/null || true; done
    umount "$HOST_MOUNT_TARGET_FOR_ANDROID" &>/dev/null || true

    su -c "rm -rf '$HOST_MOUNT_TARGET_FOR_ANDROID'" "$HOST_USER" &>/dev/null || true
    
    log "--- Share Teardown Complete ---"
}

# --- Main Execution ---
for cmd in setfacl inotifywait; do
    if ! command -v "$cmd" &>/dev/null; then error "'$cmd' is not installed. Please install the required packages." && exit 1; fi
done
if [[ -z "$HOST_USER" || -z "$HOST_HOME" ]]; then
    error "Could not determine original user's name or home directory." && exit 1
fi
if [[ -z "$ANDROID_UID" ]]; then error "Android UID is not set." && exit 1; fi

case "$1" in
    start) do_start ;;
    stop) do_stop ;;
    *) echo "Usage: $0 [start|stop]" && exit 1 ;;
esac

exit 0