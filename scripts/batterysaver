#!/bin/bash

# Final Script: Suspends native apps and kills Android apps on lock,
# then resumes native apps on unlock.

# --- CONFIGURATION ---
PID_FILE="/tmp/suspended_pids.txt"
EXCLUDED_APPS=("gnome-calls" "chatty" "gnome-clocks")

# --- FUNCTIONS ---
build_app_map() {
    echo "Building application map in memory..."
    declare -gA APP_MAP=()
    local desktop_files=$(find /usr/share/applications/ ~/.local/share/applications/ -name "*.desktop" 2>/dev/null)
    for file in $desktop_files; do
        local app_id=$(basename "$file" .desktop)
        local exec_line=$(grep -E '^Exec=' "$file" | head -1)
        if [ -n "$exec_line" ]; then
            local process_name=$(echo "$exec_line" | sed 's/Exec=//' | awk '{print $1}' | xargs basename)
            APP_MAP["$app_id"]="$process_name"
        fi
    done
    echo "Application map built."
}

contains_element() {
  local e match="$1"; shift
  for e; do [[ "$e" == "$match" ]] && return 0; done
  return 1
}

suspend_and_kill_apps() {
    echo "$(date): Screen locked. Suspending/killing apps..."
    > "$PID_FILE"
    if ! [ -x "$(command -v wlrctl)" ]; then
        echo "Error: wlrctl not found."; return 1;
    fi

    wlrctl window list | awk 'NR>1 {print $1}' | while read -r raw_app_id; do
        local app_id=${raw_app_id%:}

        if [[ "$app_id" == android.* ]]; then
            local package_name=${app_id#android.}
            if ! contains_element "$package_name" "${EXCLUDED_APPS[@]}"; then
                echo "Killing Android app: $package_name"
                sudo gdbus call --system \
                    --dest io.furios.Andromeda.Container \
                    --object-path /ContainerManager \
                    --method io.furios.Andromeda.ContainerManager.KillApp "$package_name"
            fi
        else
            local process_name=${APP_MAP[$app_id]}
            if [ -z "$process_name" ]; then
                process_name="$app_id"
            fi
            if [ -n "$process_name" ] && ! contains_element "$process_name" "${EXCLUDED_APPS[@]}"; then
                local pid=$(pgrep -f "$process_name" | head -n 1)
                if [ -n "$pid" ]; then
                    echo "Suspending native process '$process_name' (PID: $pid)"
                    kill -STOP "$pid"
                    echo "$pid" >> "$PID_FILE"
                fi
            fi
        fi
    done | uniq
    echo "Finished suspend/kill."
}

resume_apps() {
    echo "$(date): Screen unlocked. Resuming apps..."
    if [ -f "$PID_FILE" ]; then
        while read -r pid; do
            echo "Resuming native process (PID: $pid)"
            kill -CONT "$pid"
        done < "$PID_FILE"
        > "$PID_FILE"
    fi
    echo "Finished resuming."
}

# --- MAIN EXECUTION ---
build_app_map
touch "$PID_FILE"
echo "Starting Dynamic Suspend & Kill script..."

dbus-monitor --session "type='signal',interface='org.gnome.ScreenSaver',member='ActiveChanged'" | \
while read -r line; do
    if echo "$line" | grep -q "boolean true"; then
        suspend_and_kill_apps
    elif echo "$line" | grep -q "boolean false"; then
        resume_apps
    fi
done