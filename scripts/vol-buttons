#!/bin/bash

# Function to monitor for incoming calls
monitor() {
  dbus-monitor --system "interface='org.freedesktop.ModemManager1.Modem.Voice',type='signal',member='CallAdded'" |
  while read -r line; do
    if echo "$line" | grep -qE "^signal.*CallAdded"; then
    
      # Stop evremap
      killall evremap
      killall assistant-button-tweak

      # Loop while the call is active
      while true; do
        mmcli_output=$(mmcli -m any --voice-list-calls)
        if echo "$mmcli_output" | grep -q "No calls were found"; then
          echo "Call ended. Restarting evremap."
          evremap remap ~/.config/evremap/remap.toml &
          sleep 3 && assistant-button-tweak &
          break
        fi
        sleep 1  # Check for call status every second
      done
    fi
  done
}

# Start evremap in the background
evremap remap ~/.config/evremap/remap.toml &

# Start the call monitoring function
monitor