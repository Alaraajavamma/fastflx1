#!/bin/bash

# Function to check if there are active calls using mmcli
is_call_active() {
  call_status=$(mmcli -m any --voice-list-calls 2>/dev/null)
  [[ "$call_status" != *"No calls were found"* ]]
}

# Function to monitor for incoming calls
monitor() {
  dbus-monitor --system "interface='org.freedesktop.ModemManager1.Modem.Voice',type='signal',member='CallAdded'" |
  while read -r line; do
    if echo "$line" | grep -qE "^signal.*CallAdded"; then
      echo "Call detected."

      # Loop while the call is active
      while is_call_active; do
        sleep 1  # Check for call status every second
      done

      echo "Call ended."
    fi
  done
}

# Monitor button presses
device="/dev/input/event4"  # Replace with the actual device path
evtest "$device" | while read -r line; do
  # Extract the key code and value from the event
  key_code=$(echo "$line" | grep -oP 'code \K[0-9]+')
  key_value=$(echo "$line" | grep -oP 'value \K[0-9]+')

  # Handle button presses (example: volume control)
  if [ "$key_code" == "103" ] && [ "$key_value" == "1" ]; then
    wtype -P XF86AudioRaiseVolume
  elif [ "$key_code" == "108" ] && [ "$key_value" == "1" ]; then
    wtype -P XF86AudioLowerVolume
  fi
done &

# Start the call monitoring function in the background
monitor &