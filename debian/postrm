#!/bin/bash
# Copyright (C) 2024 Alaraajavamma <aki@urheiluaki.fi>
# License: GPL-3.0-or-later

set -e

if [ "$1" = "remove" ]; then
    # Attempt to find the main user (usually UID 1000 on these phones)
    TARGET_USER=$(id -nu 1000 2>/dev/null || echo "furios")
    TARGET_HOME=$(getent passwd "$TARGET_USER" | cut -d: -f6)

    if [ -d "$TARGET_HOME" ]; then
        echo "Cleaning up Tweak-FLX1s for user $TARGET_USER..."

        # Clean up broken systemd user service symlinks
        rm -f "$TARGET_HOME/.config/systemd/user/default.target.wants/tweak-flx1s-alarm.service"
        rm -f "$TARGET_HOME/.config/systemd/user/default.target.wants/tweak-flx1s-guard.service"
        rm -f "$TARGET_HOME/.config/systemd/user/default.target.wants/tweak-flx1s-gestures.service"

        # Restore Andromeda Shared Folders permissions
        echo "Restoring folder permissions..."
        for dir in "$TARGET_HOME"/*; do
            if [ -d "$dir" ]; then
                dirname=$(basename "$dir")
                # Skip Android folder (container data)
                if [ "$dirname" != "Android" ]; then
                    # Remove ACLs
                    setfacl -R -b "$dir" 2>/dev/null || true
                    # Restore ownership
                    chown -R "$TARGET_USER:$TARGET_USER" "$dir" 2>/dev/null || true
                fi
            fi
        done

        # Remove configuration files
        rm -rf "$TARGET_HOME/.config/tweak-flx1s"
        rm -rf "$TARGET_HOME/.cache/tweak-flx1s"

        echo "Tweak-FLX1s cleanup finished."
    fi

    # Restore PAM configuration if backups exist
    PAM_FILES=("sudo" "polkit-1" "biomd" "common-password")
    for file in "${PAM_FILES[@]}"; do
        if [ -f "/etc/pam.d/${file}.bak" ]; then
            echo "Restoring /etc/pam.d/${file}..."
            mv "/etc/pam.d/${file}.bak" "/etc/pam.d/${file}"
        fi
    done
fi

#DEBHELPER#
